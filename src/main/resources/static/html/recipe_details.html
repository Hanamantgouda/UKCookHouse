<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recipe Details</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Noto+Sans+Kannada:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: 'Poppins', 'Noto Sans Kannada', sans-serif; background: #f3f3f3; color: #333; }

  /* Hero banner */
  .hero { position: relative; width: 100%; height: 400px; overflow: hidden; border-radius: 12px; margin-bottom: 20px; }
  .hero img { width: 100%; height: 100%; object-fit: cover; }
  .hero-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); color: #fff; display: flex; flex-direction: column; justify-content: flex-end; }
  .hero-overlay h1 { font-size: 2.2rem; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
  .hero-overlay p { font-size: 1rem; opacity: 0.9; }
  #ratingDisplay { font-size: 1.2rem; color: #ffd700; font-weight: 600; }

  /* Rate Button on Image */
  .rate-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #e63946;
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s ease;
  }
  .rate-btn:hover { background: #ab2934; transform: scale(1.05); }

  /* Container */
  .container { max-width: 1200px; margin: auto; padding: 0 20px; }

  /* Info cards */
  .info-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap: 15px; margin-top: 20px; }
  .card { background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
  .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
  .card strong { display:block; margin-bottom:5px; color:#e63946; }

    /* Ingredients highlighting */
  .ingredient-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    margin: 4px 0;
    border-bottom: 1px solid #f3f3f3;
    font-size: 1rem;
    border-radius: 6px;
    transition: background 0.2s ease;
  }
  .ingredient-item:hover { background: #fff5f5; }
  .ingredient-status { font-size: 1.2rem; font-weight: bold; }
  .ingredient-available { color: green; }
  .ingredient-missing { color: red; }

  /* Video section */
  .video-section { margin: 30px 0; border-radius: 12px; overflow: hidden; }
  .video-section iframe, .video-section video { width: 100%; height: 400px; border:0; border-radius:12px; }

  /* Steps preview tiles */
  .steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 20px; margin-bottom: 50px; }
  .step-tile { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
  .step-tile:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
  .step-number { font-size: 1.2rem; font-weight: 600; color: #e63946; margin-bottom: 8px; }
  .step-text { font-size: 0.95rem; line-height: 1.4; }

  /* Buttons container */
  .button-group {
    display: flex;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
  }

  .btn {
    padding: 10px 25px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    background: linear-gradient(45deg,#e63946);
    color: white;
    font-weight: 600;
    transition: transform 0.2s ease, opacity 0.2s ease;
  }
  .btn:hover { transform: scale(1.05); opacity: 0.9; }

  /* Rating Popup Modal */
  .modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    padding: 25px 35px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    width: 320px;
    position: relative;
  }

  .close-btn {
    position: absolute;
    right: 10px; top: 10px;
    background: none; border: none;
    font-size: 20px; cursor: pointer;
  }

  .stars {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 15px 0;
  }

  .stars i {
    font-size: 30px;
    color: #ccc;
    cursor: pointer;
    transition: color 0.3s;
  }

  .stars i.active {
    color: #ff6f61;
  }

  .rate-submit {
    margin-top: 10px;
    background: linear-gradient(45deg,#e63946);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
  }
  .rate-submit:hover { opacity: 0.9; }

  @media(max-width:768px){
    .hero h1{ font-size:1.6rem; }
    .hero p{ font-size:0.9rem; }
  }

  #ingredientsList li {
  transition: background 0.2s ease, transform 0.1s ease;
  border-radius: 5px;
}
#ingredientsList li:hover {
  background: #ffeae9;
  transform: translateX(5px);
}

</style>
</head>
<body>

<div class="container">
  <div class="hero">
    <img id="recipeImage" src="" alt="Recipe Image">
    <button class="rate-btn" onclick="openRatingModal()">‚≠ê Rate</button>
    <div class="hero-overlay">
      <h1 id="recipeName">
        <span id="recipeTitleText"></span>
        <span id="ratingDisplay"></span>
      </h1>
      <p id="recipeDescription"></p>
    </div>
  </div>

  <div class="info-cards">
    <div class="card"><strong>Calories</strong><span id="calories"></span></div>
    <div class="card"><strong>Protein</strong><span id="protein"></span></div>
    <div class="card"><strong>Fat</strong><span id="fat"></span></div>
    <div class="card"><strong>Carbs</strong><span id="carbs"></span></div>
    <div class="card"><strong>Sugar</strong><span id="sugar"></span></div>
    <div class="card"><strong>Cholesterol</strong><span id="cholesterol"></span></div>
    <div class="card"><strong>Cooking Time</strong><span id="time"></span> mins</div>
    <div class="card"><strong>Difficulty</strong><span id="difficulty"></span></div>
    <div class="card"><strong>Famous Place</strong><span id="place"></span></div>
  </div>

  <div class="video-section" id="videoContainer"></div>
    <!-- Ingredients -->
  <h2 id="ingredientHeading" style="margin:25px 0 10px;color:#ff6f61;">Ingredients</h2>
  <ul id="ingredientsList" style="list-style:none; background:#fff; border-radius:10px; box-shadow:0 6px 15px rgba(0,0,0,0.05); padding:20px; margin-bottom:40px;"></ul>
  

  <div class="button-group">
    <button class="btn toggle-btn" onclick="toggleLanguage()">Show in Kannada</button>
    <button id="saveBtn" class="btn toggle-btn" onclick="saveRecipe()">Save Recipe</button>
  </div>

  <h2 style="margin-bottom:15px;color:#ff6f61;">Steps</h2>
  <div class="steps" id="stepsContainer"></div>
</div>

<!-- Rating Modal -->
<div class="modal" id="ratingModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeRatingModal()">√ó</button>
    <h3>Rate this Recipe</h3>
    <div class="stars" id="starsContainer">
      <i data-value="1">‚òÖ</i>
      <i data-value="2">‚òÖ</i>
      <i data-value="3">‚òÖ</i>
      <i data-value="4">‚òÖ</i>
      <i data-value="5">‚òÖ</i>
    </div>
    <button class="rate-submit" onclick="submitRating()">Rate</button>
  </div>
</div>

<script>
let language = 'en'; 
let recipeData = null;
let selectedRating = 0;

const urlParams = new URLSearchParams(window.location.search);
const recipeName = urlParams.get('name');

async function loadRecipe() {
  try {
    const res = await fetch(`/recipe?name=${encodeURIComponent(recipeName)}`);
    recipeData = await res.json();

    if (recipeData.error) { 
      alert(recipeData.error); 
      return; 
    }

    renderFullRecipe();

    const userId = document.cookie.replace(/(?:(?:^|.*;\s*)userID\s*\=\s*([^;]*).*$)|^.*$/, "$1");
    if (userId) {
      const checkRes = await fetch(`/isRecipeSaved?userId=${userId}&recipeId=${recipeData.recipe_id}`);
      const checkData = await checkRes.json();
      const saveBtn = document.getElementById("saveBtn");
      saveBtn.innerText = checkData.saved ? "Unsave Recipe" : "Save Recipe";
    }

    // Load rating for this recipe
    await loadRecipeRating(recipeData.recipe_id);

  } catch (err) {
    console.error(err);
    alert("Error fetching recipe details.");
  }
}

/* Render details */
function renderFullRecipe() {
  document.getElementById("recipeImage").src = recipeData.recipe_image || "";
  document.getElementById("calories").innerText = recipeData.calories;
  document.getElementById("protein").innerText = recipeData.protein;
  document.getElementById("fat").innerText = recipeData.fat;
  document.getElementById("carbs").innerText = recipeData.carbohydrate;
  document.getElementById("sugar").innerText = recipeData.sugar;
  document.getElementById("cholesterol").innerText = recipeData.cholesterol;
  document.getElementById("time").innerText = recipeData.cooking_time;
  document.getElementById("difficulty").innerText = recipeData.difficulty_level;
  document.getElementById("place").innerText = recipeData.famous_place;

  const videoContainer = document.getElementById("videoContainer");
  videoContainer.innerHTML = "";
  if(recipeData.recipe_video){
    if(recipeData.recipe_video.includes("youtube.com") || recipeData.recipe_video.includes("youtu.be")){
      const embedUrl = recipeData.recipe_video
        .replace("watch?v=","embed/")
        .replace("youtu.be/","youtube.com/embed/")
        .split("&")[0];
      videoContainer.innerHTML = `<iframe src="${embedUrl}" frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen></iframe>`;
    } else {
      videoContainer.innerHTML = `<video src="${recipeData.recipe_video}" controls></video>`;
    }
  }

  renderLanguageSpecificSections();
  renderIngredientsWithHighlight();

}

/* Language toggle */
function toggleLanguage(){
  language = language === 'en' ? 'kn' : 'en';
  document.querySelector(".toggle-btn").innerText = 
    language === 'en' ? 'Show in Kannada' : 'Show in English';
  renderLanguageSpecificSections();
}

function renderIngredientsWithHighlight() {
  const ingList = document.getElementById("ingredientsList");
  ingList.innerHTML = "";

  let selectedIngredients = [];
  try {
    const stored = localStorage.getItem("selectedIngredients");
    if (stored) selectedIngredients = JSON.parse(stored).map(i => i.trim().toLowerCase());
  } catch (e) {
    console.error("Error reading localStorage ingredients:", e);
  }

  if (recipeData.ingredients && recipeData.ingredients.length > 0) {
    let missingCount = 0;
    recipeData.ingredients.forEach(ing => {
      const normalized = ing.trim().toLowerCase();
      const matched = selectedIngredients.includes(normalized);
      if (!matched) missingCount++;

      const li = document.createElement("li");
      li.classList.add("ingredient-item");
      li.innerHTML = `
        <span>${ing}</span>
        <span class="ingredient-status ${matched ? 'ingredient-available' : 'ingredient-missing'}">
          ${matched ? '‚úÖ' : '‚ùå'}
        </span>
      `;
      ingList.appendChild(li);
    });

    document.getElementById("ingredientHeading").innerHTML = 
      `Ingredients <small style="color:#e63946;">(${missingCount} missing)</small>`;
  } else {
    ingList.innerHTML = "<li style='color:#888;'>No ingredients available.</li>";
  }
}

/* Render English / Kannada sections */
function renderLanguageSpecificSections() {
  document.getElementById("recipeTitleText").innerText = 
    language === 'en' ? recipeData.recipe_name : recipeData.recipe_name_kn;
  document.getElementById("recipeDescription").innerText = 
    language === 'en' ? recipeData.recipe_description : recipeData.recipe_description_kn;

  const stepsContainer = document.getElementById("stepsContainer");
  stepsContainer.innerHTML = "";
  recipeData.steps.forEach(step => {
    const div = document.createElement("div");
    div.className = "step-tile";
    div.innerHTML = `
      <div class="step-number">${language === 'en' ? step.step_number : step.step_number_kn}</div>
      <div class="step-text">${language === 'en' ? step.step : step.step_kn}</div>
    `;
    stepsContainer.appendChild(div);
  });
}

/* Save/Unsave Recipe */
async function saveRecipe() {
  if (!recipeData) return alert("Recipe not loaded yet.");

  const userId = document.cookie.replace(/(?:(?:^|.*;\s*)userID\s*\=\s*([^;]*).*$)|^.*$/, "$1");
  if (!userId) return alert("‚ö†Ô∏è User not logged in. Please log in first.");

  try {
    const checkRes = await fetch(`/isRecipeSaved?userId=${userId}&recipeId=${recipeData.recipe_id}`);
    const checkData = await checkRes.json();
    const saveBtn = document.getElementById("saveBtn");

    if (checkData.saved) {
      const res = await fetch(`/unsaveRecipe?userId=${userId}&recipeId=${recipeData.recipe_id}`, { method: "DELETE" });
      if (res.ok) { alert("‚ùå Recipe unsaved!"); saveBtn.innerText = "Save Recipe"; }
    } else {
      const res = await fetch("http://localhost:8080/saveRecipe", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: parseInt(userId), recipe_id: recipeData.recipe_id })
      });
      if (res.ok) { alert("‚úÖ Recipe saved!"); saveBtn.innerText = "Unsave Recipe"; }
    }
  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Error updating recipe status.");
  }
}

/* Rating Modal Functions */
function openRatingModal() {
  document.getElementById("ratingModal").style.display = "flex";
}
function closeRatingModal() {
  document.getElementById("ratingModal").style.display = "none";
}
document.querySelectorAll("#starsContainer i").forEach(star => {
  star.addEventListener("click", () => {
    selectedRating = parseInt(star.getAttribute("data-value"));
    document.querySelectorAll("#starsContainer i").forEach(s => s.classList.remove("active"));
    for (let i = 0; i < selectedRating; i++) {
      document.querySelectorAll("#starsContainer i")[i].classList.add("active");
    }
  });
});

/* Submit Rating */
async function submitRating() {
  if (selectedRating === 0) return alert("Please select a rating first!");
  const userId = document.cookie.replace(/(?:(?:^|.*;\s*)userID\s*\=\s*([^;]*).*$)|^.*$/, "$1");
  if (!userId) return alert("‚ö†Ô∏è Please log in to rate.");

  try {
    const res = await fetch("/saveRating", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        u_id: parseInt(userId),
        r_id: recipeData.recipe_id,
        rating: selectedRating
      })
    });
    if (res.ok) {
      alert(`‚≠ê You rated this recipe ${selectedRating}/5!`);
      closeRatingModal();
      await loadRecipeRating(recipeData.recipe_id); // refresh displayed rating
    } else {
      alert("Failed to submit rating.");
    }
  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Error submitting rating.");
  }
}

/* Fetch and display overall recipe rating */
async function loadRecipeRating(recipeId) {
  try {
    const res = await fetch(`/getRecipeRating?recipeId=${recipeId}`);
    const data = await res.json();

    const ratingDisplay = document.getElementById("ratingDisplay");

    if (data.error) {
      ratingDisplay.innerText = "‚≠ê N/A";
      return;
    }

    if (data.total_ratings === 0) {
      ratingDisplay.innerHTML = `‚≠ê No ratings yet`;
    } else {
      ratingDisplay.innerHTML = `‚≠ê ${data.average_rating}/5
              <span class="material-icons" style="color:#FFD700; font-size:24px;">üë§</span>
                                    (${data.total_ratings})`;
    }

  } catch (err) {
    console.error(err);
    document.getElementById("ratingDisplay").innerText = "‚≠ê N/A";
  }
}

loadRecipe();
</script>
</body>
</html>
